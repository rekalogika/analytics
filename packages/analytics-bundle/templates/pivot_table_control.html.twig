{% block control %}
    {% set id = random() %}

    <div data-controller="rekalogika--analytics-bundle--pivot-table"
         {% if target %}data-rekalogika--analytics-bundle--pivot-table-target-value="{{ target }}"{% endif %}
         {% if output %}data-rekalogika--analytics-bundle--pivot-table-output-value="{{ output }}"{% endif %}
         {% if urlParameter %} data-rekalogika--analytics-bundle--pivot-table-url-parameter-value="{{ urlParameter }}" {% endif %}>
        {{ block("fields") }}
        <turbo-frame id="__filters">
        </turbo-frame>
    </div>

    {{ block("turbo_stream") }}
{% endblock %}

{% block turbo_stream %}
    <turbo-frame id="turbo-frame">
        <turbo-stream action="update" target="{{ target }}">
            <template>
                {{ output|raw }}
            </template>
        </turbo-stream>

        <turbo-stream action="update" method="morph" target="__filters">
            <template>
                {{ block("filters") }}
            </template>
        </turbo-stream>
    </turbo-frame>
{% endblock turbo_stream %}

{% block fields %}
    <div class="row g-md-3 gx-3">
        <div class="col-md-4">
            <div class="row g-3 gx-3">
                <div class="col-12">
                    {% set type = "available" %}
                    {{ block("item_block") }}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="row g-md-3 gx-3">
                <div class="col-md-6">
                    {% set type = "rows" %}
                    {{ block("item_block") }}
                </div>

                <div class="col-md-6">
                    {% set type = "columns" %}
                    {{ block("item_block") }}
                </div>

                <div class="col-md-6">
                    {% set type = "values" %}
                    {{ block("item_block") }}
                </div>

                <div class="col-md-6">
                    {% set type = "filters" %}
                    {{ block("item_block") }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block item_block %}
    {% if type == 'available' %}
        {% set items = query.availableWithoutSubitems %}
        {% set description = t('Available fields', domain = 'rekalogika_analytics')|trans %}
    {% elseif type == 'rows' %}
        {% set items = query.rowsWithoutSubitems %}
        {% set description = t('Rows', domain = 'rekalogika_analytics')|trans %}
    {% elseif type == 'columns' %}
        {% set items = query.columnsWithoutSubitems %}
        {% set description = t('Columns', domain = 'rekalogika_analytics')|trans %}
    {% elseif type == 'values' %}
        {% set items = query.valuesWithoutSubitems %}
        {% set description = t('Values', domain = 'rekalogika_analytics')|trans %}
    {% elseif type == 'filters' %}
        {% set items = query.filtersWithoutSubitems %}
        {% set description = t('Filters', domain = 'rekalogika_analytics')|trans %}
    {% endif %}

    <div class="card pb-1 mb-3 mb-md-0">
        <h6 class="card-header">{{ description }}</h6>
        <ul data-type="{{ type }}"
            class="{{ type }} list-group list-group-flush"
            style="min-height: 70px">
            {% for item in items %}{{ block("item") }}{% endfor %}
        </ul>
    </div>
{% endblock %}

{% block item %}
    {% set item = query.resolve(item) %}

    {%- set color_class -%}
        {%- if item.type == 'dimension' -%}
            list-group-item-success
        {%- elseif item.type == 'measure' -%}
            list-group-item-info
        {%- elseif item.type == 'values' -%}
            list-group-item-warning
        {%- endif -%}
    {%- endset -%}

    <li data-type="{{ item.type }}"
        data-value="{{ item.key }}"
        class="list-group-item {{ color_class }} rounded-3 ms-1 me-1 mt-1 mb-0 py-1"
        style="cursor: grab">
        <div class="row align-items-center">
            <div class="col-auto me-auto">
                <span>{{ item.label|trans }}</span>
            </div>
            {% if item.choices %}
                <div class="col-auto ">
                    <select class="form-select form-select-sm py-0">
                        {% set selected = query.getSelectedSubItem(item.key) %}
                        {% for key, choice in item.choices %}
                            <option value="{{ key }}" {{ selected == key ? 'selected' }}>{{ choice|trans }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
        </div>
    </li>
{% endblock item %}

{% block filters %}
    {% if query.filterExpressions|length > 0 %}
        <div class="card mt-md-3">
            <div class="card-body">
                <div class="row gx-3">
                    {% for filter in query.filterExpressions %}
                        <div class="col-md-4">{{ block("filter") }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
{% endblock filters %}

{% block filter %}
    <div class="mb-3 mb-md-0">
        <label for="{{ filter.dimension }}-{{ id }}" class="form-label">
            {{ filter.label|trans }}
        </label>
        {{ block('filter', filter.template) }}
    </div>
{% endblock filter %}
